《狼书》阅读总结

# 第四章 更好的Node.js

## 1. 单线程会‘死’吗？

node.js是单进程的。

### 1.1 uncaughtException

使用process.on('uncaughtException', function(err){})不会造成接口崩溃。

### 1.2 异常捕获

使用try{}catch(e){}进行异常捕获，当前线程就不会因为异常而退出了。

注意点如下：

1. 同步代码才能使用try catch，异步使用异步的异常处理方式，比如promise的catch方法。
2. 不要使用太多的try catch。

### 1.3 使用pm2守护进程

node.js中有专门负责进程崩溃应用自动重启的模块，叫forever。现在被pm2代替。

### 1.4 小集群：单台服务器的多个实例

node如果想要充分利用多核优势的话，可以使用cluster模块解决多核并发问题。

nginx和haproxy等集群都是一主多从的，主机的端口通过负载均衡算法将请求转发到slave机器上。node在一台机器上启动多个实例，也是同样的原理。

同样的，使用PM2来守护进程，当线程崩溃时，会自动创建新的线程来继续服务。PM2还支持无缝重载，0秒切换，实现各种部署，监控等功能。


### 1.5 大集群：多台机器

常见的集群处理方式是Nginx和haproxy，如果是部署到阿里云上的，则使用阿里云提供的SLB负载均衡服务对多台云服务器进行流量分发。

在做负载均衡的时候，需要提供健康检查。大致方式是在服务器里提供check_health.html或者通过head请求来检测实际的服务器节点是否存活，以此来判断负载节点是否可用。

### 1.6 单线程会死的处理方式

1. 单个应用实例可以适当捕获异常，减少崩溃几率。
2. 单个实例崩溃后，使用PM2自动重启。
3. 利用多核集群同时在一台服务器上启动多个实例，降低崩溃几率。
4. 多个服务器也需要做集群。

## 2. 为Node.js正名

### 2.1 异步编程

异步流程孔子是Node.js编程的一大特性，有以下几种异步方案：

1. callback: 错误优先的风格。
2. Thunk: 将参数放到一个临时函数中，然后将临时函数传到函数体中。
3. Promise
4. Generator
5. co
6. async函数

优先选用async函数，其次是promise。

## 3. 更好的实践

### 3.1 ex.next语法

简单介绍如下：

1. call,apply，是为了改变函数运行时的上下文。
2. bind，创建一个新函数，当函数被调用时，会将this管金子设置为提供的值，函数不会立即执行。
3. Object.defineProperty(obj, prop, description)
4. delegate，将一个对象的属性和方法委托给另外一个对象。
5. only 是一个node.js模块，用于返回对象的白名单属性。

### 3.2 包管理工具-yarn

yarn的特点如下：

1. 本地缓存文件的性能更好。
2. 可以并行执行一些操作，加速对新模块的安装处理。
3. 使用lockfile，能够用确定的算法创建一个跨所有机器的一致文件。
4. 处于安全考虑，在安装进程里不允许编写包的开发者执行其他代码。

