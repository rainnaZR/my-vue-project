# 《大型网站技术架构》之万无一失 网站的高可用架构


# 第五章 万无一失网站的高可用架构

## 1. 高可用的网站架构

使用数据备份和失效转移。典型的分层模式是：应用层，服务层，数据层；应用层负责具体逻辑处理，服务层负责提供可复用的服务；数据层负责数据的存储与访问。

利用cookie记录session，或者利用独立部署的session服务器统一管理session，应用服务器每次读写session时，都访问session服务器。

## 2. 高可用的服务

高可用的服务器策略：

### 2.1 分级管理

核心服务使用更好的硬件，优先级不高的任务部署在不同的虚拟机上，核心任务部署在不同的物理机上等。

### 2.2 超时设置

### 2.3 异步调用

### 2.4 服务降级

## 3. 高可用的数据

### 3.1 数据备份

数据热备份分为两种：异步热备方式和同步热备方式。在异步写入方式下，存储服务器分为主存储服务器和从存储服务器，应用程序正常情况下链接主存储服务器，数据写入主存储服务器立即返回操作成功的响应，然后通过异步线程将写操作数据同步到从存储服务器。

### 3.2 失效转移机制

通过负载均衡进行无状态服务的失效转移。
应用服务器集群的session管理，包括session的复制，利用cookie记录session，使用专门的session服务器存储会话信息。

## 4. 高可用的服务

主要策略如下：

- 分级管理，核心应用和服务使用更好的硬件。
- 超时设置，设置超时时间，一旦超时，就抛出异常。
- 异步调用。
- 服务降级，高峰期的时候将服务降级。
- 幂等性设计，对数据做好有效性校验。

## 5. 高可用的数据

主要手段是失效转移和数据备份机制。

- 数据持久性。做好备份，保证数据不丢失。
- 数据可访问性。
- 数据一致性。

### 5.1 数据备份

数据备份分为：异步热备方式和同步热备方式。在异步写入方式下，存储服务器分为主服务器和从服务器，主存储服务器负责写入数据，通过异步线程将写操作数据同步到从存储服务器。通过从存储数据库来读取数据。

### 5.2 失效转移

- 失效确认：心跳检测和应用程序访问失败报告确定失效。
- 访问转移。
- 数据恢复。

## 6. 软件质量保证

- 网站发布
- 自动化测试
- 预发环境验证
- 自动化发布
- 灰度发布，每次发布部分服务器，确定稳定后再发布其他的，分多次发布完

## 7. 网站运行监控

### 7.1 监控数据采集

包括：网站用户行为日志，业务运行数据，系统性能数据等。





